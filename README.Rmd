---
output: github_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# spheniscus üêß

El objetivo de este paquete es  
- Hacer disponibles datos crudos de TDR para que se familiaricen con el formato  
- Ayudarte a limpiar esos datos crudos para obtener medidas de presi√≥n  
- Cortar periodos de inter√©s en nuestros datos  

The goal of spheniscus is to  
- Provide TDR raw data from devices to get familiar with the format  
- Clean raw data to obtain pressure measurements  
- Cut periods of time of interest  


## Installation
El paquete estar√° disponible solo por GitHub <br>
This package is to be only on the development version from [GitHub](https://github.com/).
```{r, eval=FALSE}
install.packages("devtools")
devtools::install_github("MiriamLL/spheniscus")
```

```{r example}
library(spheniscus)
```

## Data

### TDR_raw
Agrega los datos crudos como objeto. <br>
Includes raw data as object.
```{r, eval=FALSE}
TDR_raw<-TDR_raw
```
No separe columnas porque primero hay que cortar partes del archivo.
Load your raw data. Columns are not separated on purpose. 

### TDR_pressure
Agrega los datos editados como objeto. <br>
Includes edited data as object.
```{r, eval=FALSE}
TDR_pressure<-TDR_pressure
```

## Functions

### extract_rawdata
Extrae la informaci√≥n de presi√≥n de los datos crudos de los dispositivos.  <br>
Extracts pressure data.

Localizar donde aparece por primera vez 'Data Block 1', porque es donde empieza a medir la presion y usar esta fila para separar la presion y la temperatura (empieza donde dice 'Data Block 2').
This funcion identifies where does 'Data Block 1' occurs, and is there where the devices start measuring pressure. I use this row to separate pression and temperature recordings (temperature starts where it states 'Data Block 2').

Se toma unos minutos. Porfavor espera.
Takes some seconds. Please wait.
```{r, eval=FALSE}
TDR_pressure<-extract_pressure(data=TDR_raw, 
                          row_start='Data Block 1', 
                          row_end = 'Data Block 2')
```

### extract_trip
Corta periodos de tiempo de acuerdo a nuestro inter√©s. <br>
Cuts data to have only periods of interest. 

Se toma unos minutos. Porfavor espera.
Takes some seconds. Please wait.
```{r, eval=FALSE}
TDR_trip<-extract_trip(data=TDR_pressure,
                   timeformat="%d-%m-%Y %H:%M:%S",
                   trip_start="30-11-2018 20:43:24",
                   trip_end="01-12-2018 20:16:19")
```

Esta informacion se obtuvo de dispositivos GPS, trip_start es cuando salieron de la colonia y trip_end cuando regresaron.
This information was obtain from the GPS devices, trip_start is when the individual left the colony and trip_end when it returned.

### plot_depth
Crea un grafico con el perfil de buceos. Marca el cero con una linea roja. <br>
Creates a plot with the diving profile. Adds a red line for the zero.

```{r, echo=FALSE, eval=FALSE}
plot_depth<-function(TDR_trip=TDR_trip,
                     depth_column=depth_column,
                     time_column=time_column){
  
  TDR_trip$depth<-as.numeric(as.character(TDR_trip[,depth_column]))

  TDR_trip$time<-(TDR_trip[,time_column])

  depth_profile<-ggplot(TDR_trip,aes(x=time, y=depth))+
         geom_line()+
         ylab("Diving depth (m)")+
         xlab("Month.Day Hour:Minute")+
         scale_y_reverse()+
         theme_bw()+
         theme(panel.border = element_rect(linetype = "solid", 
                                           colour = "black", size=1.5),
               axis.line = element_line(size=1.5, colour = "black"),
               axis.text.x =  element_text(size=12),
               axis.text.y =  element_text(size=12),
               axis.title.y = element_text(size=14),
               panel.grid.major = element_blank(), 
               panel.grid.minor = element_blank(),
               panel.background = element_blank(),
               legend.position = "none")+
  geom_hline(yintercept=0, color = "red")+
         NULL

  depth_profile
  return(depth_profile)
 }
```

```{r, echo=FALSE, eval=FALSE}
#' plot_depth: Creates a plot with the diving profile. Adds a red line for the zero. Crea un grafico con el perfil de buceos. Marca el cero con una linea roja.

#'
#' @param data is a data framw with a colum including depth and a column including time (in POSIXct format)
#' @param depth_column must be a numeric value
#' @param time_column must be a date and time (in POSIXct format) (%Y-%m-d %H:%M:%S)
#'
#' @return returns a ggplot which stetics can be change using the ggplot2 sintaxis
#' @export
#'
#' @examples plot_depth(data = TDR_trip,depth_column='Pressure',time_column='daytime')
plot_depth<-function(data=data,
                     depth_column=depth_column,
                     time_column=time_column){

  depth_profile<-ggplot2::ggplot(data=.data,ggplot2::aes(x=.data[[depth_column]], y=.data[[time_column]]))+
    ggplot2::geom_line()+
    ggplot2::ylab("Diving depth (m)")+
    ggplot2::xlab("Month.Day Hour:Minute")+
    ggplot2::scale_y_reverse()+
    ggplot2::theme_bw()+
    ggplot2::theme(panel.border = ggplot2::element_rect(linetype = "solid",
                                      colour = "black", size=1.5),
                   axis.line =  ggplot2::element_line(size=1.5, colour = "black"),
                   axis.text.x =   ggplot2::element_text(size=12),
                   axis.text.y =   ggplot2::element_text(size=12),
                   axis.title.y =  ggplot2::element_text(size=14),
                   panel.grid.major =  ggplot2::element_blank(),
                   panel.grid.minor =  ggplot2::element_blank(),
                   panel.background =  ggplot2::element_blank(),
                  legend.position = "none")+
    ggplot2::geom_hline(yintercept=0, color = "red")+
    NULL

  depth_profile
  return(depth_profile)
}
```

```{r, eval=FALSE}
plot_depth(TDR_trip = TDR_trip,
                   depth_column='Pressure',
                   time_column='daytime')
```


## correct_zero

Correr funcion, si hay que corregir el cero incluir factor de correccion aqui. 
Run function, this is to correct ceros, if manual correction is needed only. 
```{r,echo=FALSE, eval=FALSE}
correct_zero<-function(TDR_trip=TDR_trip,
                       depth_column=depth_column,
                       extra_correction=extra_correction){

  extra_correction<-0+as.numeric(extra_correction)
  
  TDR_trip$depth<-as.numeric(as.character(TDR_trip[,depth_column]))
  
  TDR_trip$corrected_depth<-TDR_trip$dept-extra_correction
  return(TDR_trip)}
```

```{r, eval=FALSE, echo=FALSE}
TDR_corrected<-correct_zero(TDR_trip = TDR_trip,
             depth_column='Pressure',
             extra_correction=-0.65)
```

```{r, fig.height=5, eval=FALSE, echo=FALSE}
plot_depth(data = TDR_corrected,
                      depth_column='corrected_depth',
                      time_column='daytime')
```
## identify_dives
Esta funcion lo que hace es que identifica los buceos reales, es decir cuando bucean mas profundo de 3 metros. Identifica cada buceo como unidades individuales, y les asigna a cada inmersion, un numero, una profundidad media de buceo, una profundidad maxima de buceo, una duracion media de buceo y una duracion maxima de buceo.

This functions identify real dives, this is when the individual was deeper than 3 m from the surface. Then identifies every dive as a individual dive assigning a number, a mean diving depth, a maximum diving depth, a dive duration, a maximum dive duration. 

```{r, eval=FALSE, echo=FALSE}
TDR_corrected=TDR_corrected
real_dives=3
depth_column='corrected_depth'
```

```{r, echo=FALSE, eval=FALSE}
identify_dives<-function(TDR_corrected=TDR_corrected,
                         depth_column=depth_column,
                         real_dives=real_dives){

  TDR_corrected$dives<-as.numeric(as.character(TDR_corrected[,depth_column]))

  TDR_dives<-subset(TDR_corrected,TDR_corrected$dives >= real_dives)

  TDR_dives$numeric_sequence<-as.integer(TDR_dives$numeric_sequence)

  TDR_dives$dives<-(cumsum(c(1L, diff(TDR_dives$numeric_sequence)) != 1L))

  table_dives<-TDR_dives%>%
    dplyr::group_by(.data$dives)%>%
    dplyr::summarise(max_depth=max(.data$corrected_depth),
                     mean_depth=mean(.data$corrected_depth),
                     sd_depth=stats::sd(.data$corrected_depth),
                     dive_duration=length(.data$dives))


  return(table_dives)
  cat(paste0('A total of ',length(unique(TDR_dives$dives)),' were detected. Real dives were considered when the animal was deeper than ', real_dives,'m'))
}
```

```{r, eval=FALSE, echo=FALSE}
table_dives<-identify_dives(TDR_corrected=TDR_corrected,
               real_dives=3,
               depth_column='corrected_depth')
```

```{r, eval=FALSE, echo=FALSE}
head(table_dives)
```

## dive_parameters
```{r, eval=FALSE, echo=FALSE}
calculate_diveparams<-function(table_dives=table_dives){
  dive_parameters<- table_dives %>%
    summarise(max_depth_mean=mean(max_depth),
              max_depth_sd=sd(max_depth),
              max_depth_max=max(max_depth),
              
              dive_duration_mean=mean(dive_duration),
              dive_duration_sd=stats::sd(dive_duration),
              dive_duration_max=max(dive_duration),
              
              n_dives=length(dive_duration)
            )
  return(dive_parameters)
}
```

```{r, eval=FALSE, echo=FALSE}
dive_parameters<-calculate_diveparams(table_dives)
```


# Citation

Este script acompa√±a una publicacion en ping√ºinos por Lerma et al. (en preparacion)
This script is supporting information from a publication by Lerma et al. (in preparation)

Please citate the package as:
Lerma, M (2021). Package spheniscus (Version v1.0). Zenodo. http://doi.org/10.5281/zenodo.4709837 

[![DOI](https://zenodo.org/badge/360213200.svg)](https://zenodo.org/badge/latestdoi/360213200)
